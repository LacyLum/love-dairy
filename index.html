<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>我们的恋爱日记</title>
  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: linear-gradient(135deg, #ffe6f0, #fff0f5);
      margin: 0; padding: 0; text-align: center;
    }
    h1 {
      background: pink;
      padding: 20px; margin: 0;
      position: relative;
    }
    h1::after {
      content: "💖";
      margin-left: 10px;
      animation: heartbeat 1.2s infinite;
    }
    @keyframes heartbeat {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.3); }
    }
    section { 
      margin: 20px auto; 
      max-width: 800px; 
      padding: 15px; 
      background: white; 
      border-radius: 15px; 
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    img {
      border-radius: 10px;
      transition: transform 0.3s;
    }
    img:hover { transform: scale(1.05); }
    .msg { 
      background: #fff5fa; 
      border-radius: 8px; 
      padding: 10px; 
      margin: 10px 0; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
      text-align: left; 
    }
    button {
      cursor: pointer;
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      font-weight: bold;
    }
    .btn-pink { background:#ff69b4; color:white; }
    .btn-green { background:#4caf50; color:white; }
    textarea, input[type=text] {
      width:80%; padding:10px;
      border-radius:8px;
      border:1px solid #ccc;
    }
  </style>
</head>
<body>
  <h1>我们的恋爱日记</h1>

  <!-- 倒计时 -->
  <section>
    <h2>纪念日倒计时</h2>
    <p id="daysTogether" style="font-size:1.2em; font-weight:bold;"></p>
    <p id="milestoneMessage" style="color:red; font-weight:bold;"></p>
    <p id="countdownMessage" style="color:purple; font-weight:bold;"></p>
  </section>

  <!-- 相册 -->
  <section>
    <h2>我们的相册</h2>
    <input type="file" id="photoInput" accept="image/*">
    <button class="btn-green" onclick="uploadToCloudinary()">上传照片</button>
    <p id="uploadStatus"></p>
    <div id="photoGallery" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;margin-top:15px;"></div>
  </section>

  <!-- 留言板 -->
  <section>
    <h2>留言板</h2>
    <div id="messageList"></div>
    <textarea id="msgInput" placeholder="写下今天的心情..."></textarea><br>
    <button class="btn-pink" onclick="addMessage()">💬 添加留言</button>
  </section>

  <script>
    const githubJsonUrl = "https://raw.githubusercontent.com/LacyLum/love-dairy/main/cloudinary_image_links.json";

    async function loadPhotosFromGitHub() {
      try {
        const res = await fetch(githubJsonUrl);
        const photos = await res.json();
        const gallery = document.getElementById("photoGallery");
        gallery.innerHTML = photos.map(url => `<img src="${url}" width="200">`).join('');
      } catch (e) {
        console.error("加载 GitHub 相册失败", e);
      }
    }

    async function uploadToCloudinary() {
      const file = document.getElementById('photoInput').files[0];
      if (!file) {
        document.getElementById('uploadStatus').innerText = "请先选择一张照片";
        return;
      }

      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", "love_diary_upload"); // 替换为你的 preset

      const response = await fetch("https://api.cloudinary.com/v1_1/dqpyvkirr/image/upload", {
        method: "POST",
        body: formData
      });
      const data = await response.json();
      const url = data.secure_url;

      document.getElementById('uploadStatus').innerHTML = `上传成功！<br><img src="${url}" width="200">`;
      alert("请把这个链接手动加到 cloudinary_image_links.json 里：\n" + url);

      loadPhotosFromGitHub();
    }

    const repoOwner = "LacyLum";
    const repoName = "love-dairy";
    const branch = "main";
    const token = "你的GitHubToken"; // ⚠️ 仅测试用，别长期放前端
    const filePath = "messages.json";

    async function loadMessagesFromGitHub() {
      const res = await fetch(`https://raw.githubusercontent.com/${repoOwner}/${repoName}/${branch}/${filePath}`);
      const data = await res.json();
      renderMessages(data);
    }

    function renderMessages(msgs) {
      const container = document.getElementById("messageList");
      container.innerHTML = msgs.map(m => `
        <div class="msg"><b>${m.time}</b><br>${m.text}</div>
      `).join("");
    }

    async function addMessage() {
      const input = document.getElementById("msgInput").value.trim();
      if (!input) return alert("请输入留言内容");

      const time = new Date().toLocaleString();
      const newMsg = { time, text: input };

      const res = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`, {
        headers: { Authorization: `token ${token}` }
      });
      const fileData = await res.json();
      const content = JSON.parse(atob(fileData.content));
      content.push(newMsg);

      const updateRes = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`, {
        method: "PUT",
        headers: {
          "Authorization": `token ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          message: "Add new message",
          content: btoa(unescape(encodeURIComponent(JSON.stringify(content, null, 2)))),
          sha: fileData.sha,
          branch
        })
      });

      if (updateRes.ok) {
        alert("留言成功啦 💖");
        document.getElementById("msgInput").value = "";
        loadMessagesFromGitHub();
      } else {
        alert("留言失败，请检查 Token 或仓库权限");
      }
    }

    function updateTimer() {
      const startDate = new Date("2024-09-01T00:00:00");
      const now = new Date();
      const diff = now - startDate;
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      document.getElementById("daysTogether").textContent = `我们已经在一起 ${days} 天啦 💕`;

      const milestones = [100, 200, 365, 520, 730, 1000];
      if (milestones.includes(days)) {
        document.getElementById("milestoneMessage").textContent = `🎉 今天是我们在一起的第 ${days} 天！特别的日子 💖`;
      } else {
        document.getElementById("milestoneMessage").textContent = "";
      }

      const years = Math.floor(days / 365);
      const nextAnniversary = new Date(startDate);
      nextAnniversary.setFullYear(startDate.getFullYear() + years + 1);
      const diffNext = nextAnniversary - now;
      const daysLeft = Math.ceil(diffNext / (1000 * 60 * 60 * 24));
      document.getElementById("countdownMessage").textContent = `📅 距离我们的 ${years + 1} 周年纪念日还有 ${daysLeft} 天 💜`;
    }

    window.addEventListener("load", () => {
      loadPhotosFromGitHub();
      loadMessagesFromGitHub();
      updateTimer();
      setInterval(updateTimer, 60000);
    });
  </script>
</body>
</html>
